<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sist.back.mapper.PostMapper">

    <resultMap id="post_image_map" type="com.sist.back.vo.PostVO">
        <id column="postkey" property="postkey" />
        <association property="likedqty" select="getLikedQty" column="postkey" javaType="int"/>
        <association property="chatroomqty" select="getChatroomQty" column="postkey" javaType="int"/>
        <collection property="pImg_list" select="getPImg_listByPostKey" column="postkey" ofType="com.sist.back.vo.PostImgVO" />
    </resultMap>

    <resultMap id="postMap" type="com.sist.back.vo.PostVO">
        <id column="postkey" property="postkey" />
        <result column="categorykey" property="categorykey" />
        <result column="userkey" property="userkey" />
        <result column="dealuserkey" property="dealuserkey" />
        <result column="townkey" property="townkey" />
        <association property="cvo" select="getCvoByPostKey" column="categorykey" javaType="com.sist.back.vo.categoryVO"/>
        <association property="townVO" select="com.sist.back.mapper.TownMapper.searchTownByKey" column="townkey" javaType="com.sist.back.vo.TownVO"/>
        <association property="uvo" select="getUvoByPostKey" column="userkey" javaType="com.sist.back.vo.userVO"/>
        <association property="duvo" select="getUvoByDealUserKey" column="dealuserkey" javaType="com.sist.back.vo.userVO"/>
        <association property="likedqty" select="getLikedQty" column="postkey" javaType="int"/>
        <association property="chatroomqty" select="getChatroomQty" column="postkey" javaType="int"/>
        <collection property="pImg_list" select="getPImg_listByPostKey" column="postkey" ofType="com.sist.back.vo.PostImgVO" />
        <collection property="pInfo_list" select="getPInfo_listByPostKey" column="postkey" ofType="com.sist.back.vo.PostInfoVO" />
    </resultMap>

    <!-- 게시글 상세 필요 데이터 추가본 -->
    <resultMap id="user_cell_map" type="com.sist.back.vo.userVO">
        <id column="userkey" property="userkey"/>
        <!--a_list 매핑-->
        <collection property="a_list" ofType="com.sist.back.vo.AddressVO" select="getAddressListByUserKey" column="userkey"/>
        <!--cell_list 매핑-->
        <collection property="cell_list" ofType="com.sist.back.vo.PostVO" select="getCellListByUserKey" column="userkey"/>
        <collection property="m_list" ofType="com.sist.back.vo.MannerVO" select="getMannerListByUserKey" column="userkey"/>
    </resultMap>
    <resultMap id="address_town_map" type="com.sist.back.vo.AddressVO">
        <result column="townkey" property="townkey"/>
        <association property="tvo" javaType="com.sist.back.vo.TownVO" select="getTownByTownKey" column="townkey"/>
    </resultMap>



    <resultMap id="offerMap" type="com.sist.back.vo.OfferVO">
        <result column="offeruserkey" property="offeruserkey" />
        <association property="ouvo" select="getUserByOfferUserKey" column="offeruserkey" javaType="com.sist.back.vo.userVO"/>
    </resultMap>

    <resultMap id="chatroomMap" type="com.sist.back.vo.ChatroomVO">
      <id column="chatroomkey" property="chatroomkey" />
          <result column="chatuserkey" property="chatuserkey" />
          <association property="cuvo" select="getUserByChatUserKey" column="chatuserkey" javaType="com.sist.back.vo.userVO"/>
        <collection property="c_list" select="getChattingByChatroomKey" column="chatroomkey" ofType="com.sist.back.vo.ChattingVO" />
    </resultMap>
    <resultMap id="chattingMap" type="com.sist.back.vo.ChattingVO">
      <id column="chattingkey" property="chattingkey" />
          <result column="chattingemozikey" property="chattingemozikey" />
          <association property="cevo" select="getChattingemoziByChattingemoziKey" column="chattingemozikey" javaType="com.sist.back.vo.ChattingEmoziVO"/>
          <collection property="ci_list" select="getChatimgByChattingKey" column="chattingkey" ofType="com.sist.back.vo.ChatImgVO"/>
    </resultMap>

    <select id="all" resultType="com.sist.back.vo.PostVO">
      SELECT * FROM post
    </select>

    <!-- 1. post 관련 데이터 -->
    <select id="getPostByPostKey" resultMap="postMap" parameterType="int">
        SELECT * FROM `post`
        WHERE postkey = #{postkey}
    </select>
    <select id="getCvoByPostKey" resultType="com.sist.back.vo.categoryVO" parameterType="int">
        SELECT * FROM `category`
        WHERE categorykey = #{categorykey}
    </select>
    <select id="getUvoByPostKey" resultMap="user_cell_map" parameterType="int">
        SELECT * FROM `user`
        WHERE userkey = #{userkey}
    </select>
    <select id="getUvoByDealUserKey" resultType="com.sist.back.vo.userVO" parameterType="int">
        SELECT * FROM `user`
        WHERE userkey = #{dealuserkey}
    </select>
    <select id="getPImg_listByPostKey" resultType="com.sist.back.vo.PostImgVO" parameterType="int">
        SELECT * FROM `postimg`
        WHERE postkey = #{postkey}
    </select>
    <select id="getPInfo_listByPostKey" resultType="com.sist.back.vo.PostInfoVO" parameterType="int">
        SELECT * FROM `post_info`
        WHERE postkey = #{postkey}
    </select>


    <!-- 2. town 관련 데이터 -->
    <select id="getTownByPostKey" resultType="com.sist.back.vo.TownVO" parameterType="int">
        SELECT * FROM `town`
        WHERE townkey = (SELECT townkey
                        FROM `post`
                        WHERE postkey = #{postkey})
    </select>

    <!-- 3. offer 관련 데이터 -->
    <select id="getOfferByPostKey" resultMap="offerMap" parameterType="int">
        SELECT * FROM `offer`
        WHERE postkey = #{postkey}
    </select>

    <select id="getUserByOfferUserKey" resultType="com.sist.back.vo.userVO" parameterType="int">
        SELECT * FROM `user`
        WHERE userkey = #{offeruserkey}
    </select>

    <!-- 4. chatroom 관련 데이터 -->
    <select id="getChatroomByPostKey" resultMap="chatroomMap" parameterType="int">
        SELECT * FROM `chatroom`
        WHERE postkey = #{postkey}
    </select>

    <select id="getUserByChatUserKey" resultType="com.sist.back.vo.userVO" parameterType="int">
        SELECT * FROM `user`
        WHERE userkey = #{chatuserkey}
    </select>

    <select id="getChattingByChatroomKey" resultMap="chattingMap" parameterType="int">
        SELECT * FROM `chatting`
        WHERE chatroomkey = #{chatroomkey}
    </select>

    <select id="getChatimgByChattingKey" resultType="com.sist.back.vo.ChatImgVO" parameterType="int">
        SELECT * FROM `chatimg`
        WHERE chattingkey = #{chattingkey}
    </select>

    <select id="getChattingemoziByChattingemoziKey" resultType="com.sist.back.vo.ChattingEmoziVO" parameterType="int">
        SELECT * FROM `chattingemozi`
        WHERE chattingemozikey = #{chattingemozikey}
    </select>


    <!-- 게시글 상세 필요 데이터 추가본 -->
    <select id="getPostByCategoryKey" resultMap="post_image_map" parameterType="int">
        SELECT *
        FROM `post`
        WHERE categorykey = #{categorykey}
        ORDER BY viewqty DESC
        LIMIT 15
    </select>
    <select id="getCellListByUserKey" resultMap="post_image_map" parameterType="int">
        SELECT *
        FROM `post`
        WHERE userkey = #{userkey}
        AND poststatus IN (1,2)
    </select>
    <select id="getCellListByUserPostKey" resultMap="post_image_map" parameterType="Map">
        SELECT *
        FROM `post`
        WHERE userkey = #{userkey}
        AND postkey != #{postkey}
        AND poststatus IN (1,2)
    </select>
    <select id="getAddressListByUserKey" resultMap="address_town_map" parameterType="String">
        SELECT *
        FROM `address`
        WHERE userkey = #{userkey}
    </select>
    <select id="getTownByTownKey" resultType="com.sist.back.vo.TownVO" parameterType="String">
        SELECT *
        FROM `town`
        WHERE townkey = #{townkey}
    </select>
    <select id="getMannerListByUserKey" resultType="com.sist.back.vo.MannerVO" parameterType="String">
        SELECT *
        FROM `manner`
        WHERE userkey = #{userkey}
    </select>


    <!-- 5. userreview 관련 데이터 -->
    <select id="getReviewListByReviewListKey" resultType="com.sist.back.vo.ReviewListVO" parameterType="int">
        SELECT * FROM `reviewlist`
        WHERE reviewlistkey = #{reviewlistkey}
    </select>

    <!-- post 관련 채팅방 갯수, 관심받은 횟수 -->
    <select id="getLikedQty" resultType="int" parameterType="String">
        SELECT COUNT(*)
        FROM `wishlist`
        WHERE postkey = #{postkey}
    </select>
    <select id="getChatroomQty" resultType="int" parameterType="String">
        SELECT COUNT(*)
        FROM `chatroom`
        WHERE postkey = #{postkey}
    </select>

    <!-- 조회수 증가 -->
    <select id="getViewqty" resultType="int" parameterType="int">
        SELECT viewqty
        FROM `post`
        WHERE postkey = #{postkey}
    </select>

    <update id="incViewqty" parameterType="int">
        UPDATE `post`
        SET viewqty = viewqty+1
        WHERE postkey = #{postkey}
    </update>


    <insert id="insertRemindPost" parameterType="String">
        INSERT
        INTO `post_info`(postkey,isupdate,dtm)
        VALUES (#{postkey},1,NOW())
    </insert>

    <update id="remindPostByPostKey" parameterType="String">
        UPDATE `post`
        SET update_dtm = NOW(), remind_dtm = NOW()
        WHERE postkey = #{postkey}
    </update>

    <update id="unhidPostByPostKey" parameterType="String">
        UPDATE `post`
        SET poststatus = '1', update_dtm = NOW()
        WHERE postkey = #{postkey}
    </update>


    <delete id="delWishlistByKey" parameterType="String">
        DELETE
        FROM `wishlist`
        WHERE wishlistkey = #{likeKey}
    </delete>
    <delete id="delInterestcategoryByKey" parameterType="String">
        DELETE
        FROM `interestcategory`
        WHERE autokey = #{likeKey}
    </delete>
    <delete id="delKeywordByKey" parameterType="String">
        DELETE
        FROM `keyword`
        WHERE keywordkey = #{likeKey}
    </delete>


    <!-- PostVO와 PostImgVO를 매핑하는 resultMap -->
    <resultMap id="post_image_map_2" type="com.sist.back.vo.PostVO">
        <id column="postkey" property="postkey"/>
        <result column="title" property="title"/>
        <!-- 게시글의 다른 컬럼들 -->
        <collection property="pImg_list" ofType="com.sist.back.vo.PostImgVO">
            <id column="postimgkey" property="postimgkey"/>
            <result column="imgurl" property="imgurl"/>
            <!-- PostImgVO의 다른 필드들 -->
        </collection>
    </resultMap>

    <select id="searchpost" resultMap="postMap">
        SELECT *
        FROM post p        
        WHERE 1 = 1
        <!-- 검색분류 -->
        
        <if test="searchCategory != null and searchCategory != '' and searchCategoryText != null and searchCategoryText != ''">
            <if test="searchCategory == 'title'">
                AND title LIKE CONCAT('%', #{searchCategoryText}, '%')
            </if>
            <if test="searchCategory == 'postkey'">
                AND postkey = #{searchCategoryText}
            </if>
            <if test="searchCategory == 'hope_place'">
                AND hope_place LIKE CONCAT('%', #{searchCategoryText}, '%')
            </if>
            <if test="searchCategory == 'townkey'">
                AND townkey = #{searchCategoryText}
            </if>
            <if test="searchCategory == 'userkey'">
                AND userkey = #{searchCategoryText}
            </if>
        </if>
        <!-- 게시글 분류 -->
        <if test="categorykey != null and categorykey != '' and categorykey != '- 분류 선택 -'">
            AND categorykey = #{categorykey}
        </if>
        <!-- 판매상태 -->
        <if test="poststatus != null and poststatus != ''">
            AND poststatus = #{poststatus}
        </if>
        <!-- 거래방식 -->
        <if test="method != null and method != ''">
            AND method = #{method}
        </if>
        <!-- 상품 가격 -->
        <if test="minPrice != null and minPrice != ''">
            AND price &gt;= #{minPrice}
        </if>
        <if test="maxPrice != null and maxPrice != ''">
            AND price &lt;= #{maxPrice}
        </if>
        <!-- 흥정 가능 여부 -->
        <if test="canbargain != null and canbargain != ''">
            AND canbargain = #{canbargain}
        </if>
        <!-- 게시글 생성일 -->
        <if test="create_dtm_a != null and create_dtm_a != ''">
            AND create_dtm &gt;= #{create_dtm_a}
        </if>
        <if test="create_dtm_b != null and create_dtm_b != ''">
            AND create_dtm &lt;= #{create_dtm_b}
        </if>

        <!-- 게시글 수정일 -->
        <if test="update_dtm_a != null and update_dtm_a != ''">
            AND update_dtm &gt;= #{update_dtm_a}
        </if>
        <if test="update_dtm_b != null and update_dtm_b != ''">
            AND update_dtm &lt;= #{update_dtm_b}
        </if>

        <!-- 게시글 삭제일 -->
        <if test="delete_dtm_a != null and delete_dtm_a != ''">
            AND delete_dtm &gt;= #{delete_dtm_a}
        </if>
        <if test="delete_dtm_b != null and delete_dtm_b != ''">
            AND delete_dtm &lt;= #{delete_dtm_b}
        </if>

        <!-- 끌어올리기 일자 -->
        <if test="remind_dtm_a != null and remind_dtm_a != ''">
            AND remind_dtm &gt;= #{remind_dtm_a}
        </if>
        <if test="remind_dtm_b != null and remind_dtm_b != ''">
            AND remind_dtm &lt;= #{remind_dtm_b}
        </if>

        <!-- 거래 완료 일자 -->
        <if test="deal_dtm_a != null and deal_dtm_a != ''">
            AND deal_dtm &gt;= #{deal_dtm_a}
        </if>
        <if test="deal_dtm_b != null and deal_dtm_b != ''">
            AND deal_dtm &lt;= #{deal_dtm_b}
        </if>
        
    </select>

    <insert id="writePost" parameterType="com.sist.back.vo.PostVO" useGeneratedKeys="true" keyProperty="postkey">
    INSERT INTO `post`
        (
        `userkey`,
        `townkey`,
        `categorykey`,
        `title`,
        `method`,
        `price`,
        `lastprice`,
        `content`,
        `range`,
        <if test="hope_place != null and hope_place != ''">
            `hope_place`,
        </if>
        <if test="hope_lati != null and hope_lati != ''">
            `hope_lati`,
        </if>
        <if test="hope_long != null and hope_long != ''">
            `hope_long`,
        </if>
        `canbargain`,
        `viewqty`,
        `create_dtm`,
        `update_dtm`,
        `delete_dtm`,
        `remind_dtm`,
        `dealuserkey`,
        `deal_dtm`,
        `userreview`,
        `userreviewimg`,
        `userreview_dtm`,
        `dealuserreview`,
        `dealuserreviewimg`,
        `dealuserreview_dtm`,
        `poststatus`,
        `isdeleted`,
        `iscellvisible`,
        `isbuyvisible`
        )
        VALUES
        (
        #{userkey},
        #{townkey},
        #{categorykey},
        #{title},
        #{method},
        #{price},
        #{lastprice},
        #{content},
        #{range},
        <if test="hope_place != null and hope_place != ''">
            #{hope_place},
        </if>
        <if test="hope_lati != null and hope_lati != ''">
            #{hope_lati},
        </if>
        <if test="hope_long != null and hope_long != ''">
            #{hope_long},
        </if>
        #{canbargain},
        #{viewqty},
        <if test="poststatus == 0">
            #{create_dtm},
            #{update_dtm},
        </if>
        <if test="poststatus == 1">
            now(),
            now(),
        </if>
        #{delete_dtm},
        <if test="poststatus == 0">
            #{remind_dtm},
        </if>
        <if test="poststatus == 1">
            now(),
        </if>
        #{dealuserkey},
        #{deal_dtm},
        #{userreview},
        #{userreviewimg},
        #{userreview_dtm},
        #{dealuserreview},
        #{dealuserreviewimg},
        #{dealuserreview_dtm},
        #{poststatus},
        0,
        #{iscellvisible},
        #{isbuyvisible}
        )
    </insert>

    <delete id="deletePostImg" parameterType="String">
        DELETE FROM `postimg`
         WHERE postkey=#{postkey}
    </delete>

    <update id="editPost" parameterType="com.sist.back.vo.PostVO">
    UPDATE `post`
        SET
        `townkey` = #{townkey},
        `categorykey` = #{categorykey},
        `title` = #{title},
        `method` = #{method},
        `price` = #{price},
        `lastprice` = #{lastprice},
        `content` = #{content},
        `range` = #{range},
        `hope_place` = #{hope_place},
        `hope_lati` = #{hope_lati},
        `hope_long` = #{hope_long},
        `canbargain` = #{canbargain},
        <if test="isPostPage = 1 and poststatus != 0">
        `create_dtm` = now(),
        </if>
        `update_dtm` = now(),
        <if test="isPostPage = 0">
        `remind_dtm` = #{remind_dtm},
        </if>
        <if test="isPostPage = 1 and poststatus != 0">
        `remind_dtm` = now(),
        </if>
        `dealuserkey` = #{dealuserkey},
        `deal_dtm` = #{deal_dtm},
        `userreview` = #{userreview},
        `userreviewimg` = #{userreviewimg},
        `userreview_dtm` = #{userreview_dtm},
        `dealuserreview` = #{dealuserreview},
        `dealuserreviewimg` = #{dealuserreviewimg},
        `dealuserreview_dtm` = #{dealuserreview_dtm},
        `poststatus` = #{poststatus},
        `iscellvisible` = #{iscellvisible},
        `isbuyvisible` = #{isbuyvisible}
        WHERE `postkey` = #{postkey}
    </update>

    <select id="search" resultMap="postMap" parameterType="map">
        SELECT * FROM `post`
         WHERE 1 = 1
        <if test="category != null and category != ''">
            AND categorykey = #{category}
        </if>
        <if test="minPrice != null and minPrice != ''">
            AND price <![CDATA[>=]]> #{minPrice}
        </if>
        <if test="maxPrice != null and maxPrice != ''">
            AND price <![CDATA[<=]]> #{maxPrice}
        </if>
        <if test="sort != null and sort != ''">
            <if test="sort == 'recent'">
                ORDER BY remind_dtm DESC
            </if>
            <if test="sort == 'popular'">
                ORDER BY viewqty DESC
            </if>
        </if>
    </select>

    <select id="main" resultMap="postMap" parameterType="String">
        select * from `post`
         where 1 = 1
          <if test ="param == 'free'">
            AND method = 1 AND price = 0
          </if>
          <if test="param != 'free'">
            AND categorykey = #{param}
          </if>

          ORDER BY remind_dtm DESC
          limit 10
    </select>

    <!-- 관리자 게시글 현황 정보 카운트 -->
    <select id="countpostForAdmin" resultType="com.sist.back.vo.PostCountVO">
    SELECT 
        COUNT(*) AS all_posts, -- 전체 게시글 수
        COUNT(CASE WHEN poststatus = 0 THEN 1 END) AS tem_save_posts, 
        COUNT(CASE WHEN poststatus = 1 THEN 1 END) AS sale_posts, 
        COUNT(CASE WHEN poststatus = 2 THEN 1 END) AS saleing_posts, 
        COUNT(CASE WHEN poststatus = 3 THEN 1 END) AS saled_posts, 
        COUNT(CASE WHEN poststatus = 4 THEN 1 END) AS hide_posts 
    FROM post;
    </select>


     <!-- 여러 상태를 IN 조건으로 조회 -->
    <select id="findAllByPoststatusIn" parameterType="list" resultType="com.sist.back.vo.PostVO">
        SELECT * FROM post WHERE poststatus IN
        <foreach item="status" collection="list" open="(" separator="," close=")">
            #{status}
        </foreach>
    </select>

    <!-- 특정 상태를 조회 -->
    <select id="findByPoststatus" parameterType="int" resultType="com.sist.back.vo.PostVO">
        SELECT * FROM post WHERE poststatus = #{poststatus}
    </select>

</mapper>


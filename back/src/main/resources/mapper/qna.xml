<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sist.back.mapper.QnaMapper">
  
    <!-- 빈 글 추가 -->
    <insert id="emptyAdd" useGeneratedKeys="true" keyProperty="qnakey">
        INSERT INTO qna(userkey, create_dtm, isanswered, isdeleted)
        VALUES(#{userkey}, NOW(), 0, 0)
    </insert>

    <!-- 사용자 질문 -->
    <update id="question" parameterType="com.sist.back.vo.QnaVO">
        UPDATE qna
        SET userkey = #{userkey}, title = #{title}, content = #{content}, create_dtm = NOW(), isanswered = 0, isdeleted = 0
        WHERE qnakey = #{qnakey}
    </update>

    <!-- 문의하기 취소 시에 빈 글 삭제 -->
    <delete id="deleteLatest" parameterType="String">
        DELETE q FROM qna q
        JOIN ( SELECT qnakey FROM qna WHERE userkey = #{userkey} ORDER BY create_dtm DESC LIMIT 1)
        AS subquery ON q.qnakey = subquery.qnakey
    </delete>

    <!-- 관리자 답변 -->
    <update id="answer" parameterType="com.sist.back.vo.QnaVO">
        UPDATE qna
        SET answer = #{answer}, answer_dtm = NOW(), isanswered = 1
        WHERE qnakey = #{qnakey}
    </update>

    <!-- 문의 삭제 -->
    <update id="delete" parameterType="String">
        UPDATE qna
        SET delete_dtm = NOW(), isdeleted = 1
        WHERE qnakey = #{qnakey}
    </update>

    <!-- 전체 데이터 출력 -->
    <select id="all" resultType="com.sist.back.vo.QnaVO" parameterType="map">
        SELECT * 
        FROM (
            SELECT @RN:=@RN+1 AS rnum, a.*
            FROM (
                SELECT q.*
                FROM qna q
                ORDER BY q.qnakey DESC
            ) a, (SELECT @RN:=0) r
        ) c
        WHERE c.rnum BETWEEN #{begin} AND #{end}
    </select>

    <!-- 답변 여부로 데이터 출력 -->
    <select id="select" resultType="com.sist.back.vo.QnaVO" parameterType="map">
        SELECT *
        FROM (
            SELECT @RN:=@RN+1 AS rnum, a.*
            FROM (
                SELECT q.*
                FROM qna q
                WHERE q.isdeleted = 0 AND q.isanswered = #{isanswered}
                ORDER BY q.qnakey DESC
            ) a, (SELECT @RN:=0) r
        ) c
        WHERE c.rnum BETWEEN #{begin} AND #{end}
    </select>

    <!--총 게시물의 수를 반환-->
    <select id="count" resultType="int">
        SELECT COUNT(*) FROM qna
    </select>

    <!-- 답변 여부로 문의사항의 수 반환 -->
    <select id="selectCount" resultType="int" parameterType="String">
        SELECT COUNT(*)
        FROM qna q
        WHERE q.isdeleted = 0
        AND q.isanswered = #{isanswered}
    </select>

    <select id="userAll" resultType="com.sist.back.vo.QnaVO" parameterType="map">
        SELECT * 
        FROM (
            SELECT @RN:=@RN+1 AS rnum, a.*
            FROM (
                SELECT q.*
                FROM qna q
                WHERE userkey = #{userkey}
                ORDER BY q.qnakey DESC
            ) a, (SELECT @RN:=0) r
        ) c
        WHERE c.rnum BETWEEN #{begin} AND #{end}
    </select>

    <select id="userCount" resultType="int">
        SELECT COUNT(*)
        FROM qna
        WHERE userkey = #{userkey}
    </select>

	<!-- 선택한 문의 가져오기 -->
	<select id="getQuestion" parameterType="String" resultType="com.sist.back.vo.QnaVO">
		SELECT * FROM qna
		WHERE qnakey = #{qnakey}
	</select>
</mapper>
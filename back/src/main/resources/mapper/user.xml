<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sist.back.mapper.UserMapper">
    <select id="login" resultType="com.sist.back.vo.userVO" parameterType="com.sist.back.vo.userVO">
        SELECT * FROM user
         WHERE id = #{id} and pw = #{pw}
    </select>

    <update id="login_dtm" parameterType="com.sist.back.vo.userVO">
        UPDATE user
           SET login_dtm = now()
         WHERE userkey = #{userkey}
    </update>

    <!-- 관리자 유저정보 뿌리기-->
    <select id="countForAdmin" resultType="com.sist.back.vo.UserCountVO">
      SELECT COUNT(*) cntAll, 
          COUNT(CASE WHEN isdeleted = 0 THEN 1 END) cntNotDel,
            COUNT(CASE WHEN isdeleted = 1 THEN 1 END) cntDel
        FROM user
	  </select> 

    <select id="searchForAdminPaging" parameterType="map" resultType="int">
      SELECT COUNT(*)
      FROM user
      <where>
        <if test= "type != ''">
          <choose>
            <when test="search_type == 'name'">AND name LIKE CONCAT('%', #{type}, '%')</when>
            <when test="search_type == 'id'">AND id LIKE CONCAT('%', #{type}, '%')</when>
            <when test="search_type == 'email'">AND email LIKE CONCAT('%', #{type}, '%')</when>
            <when test="search_type == 'phone'">AND phone LIKE CONCAT('%', #{type}, '%')</when>
            <when test="search_type == 'nickname'">AND nickname LIKE CONCAT('%', #{type}, '%')</when>
          </choose>
        </if>

        <if test="regist_start_date != '' and regist_end_date != ''">
          AND create_dtm BETWEEN #{regist_start_date} AND #{regist_end_date}
        </if>
        <if test="regist_start_date != '' and regist_end_date == ''">
          AND create_dtm <![CDATA[>=]]> #{regist_start_date}
        </if>
        <if test="regist_start_date == '' and regist_end_date != ''">
          AND create_dtm <![CDATA[<=]]> #{regist_end_date}
        </if>

        <if test="recent_login_start_date != '' and recent_login_end_date != ''">
          AND login_dtm BETWEEN #{recent_login_start_date} AND #{recent_login_end_date}
        </if>
        <if test="recent_login_start_date != '' and recent_login_end_date != ''">
          AND login_dtm <![CDATA[>=]]> #{recent_login_start_date}
        </if>
        <if test="recent_login_start_date != '' and recent_login_end_date != ''">
          AND login_dtm <![CDATA[<=]]> #{recent_login_end_date}
        </if>

        <if test="isdeleted != '2'">
          AND isdeleted = #{isdeleted}
        </if>

        <if test="isauthorized != '2'">
          AND isauthorized = #{isauthorized}
        </if>
      </where>
    </select>

    <select id="searchForAdmin" parameterType="map" resultType="com.sist.back.vo.userVO">
      SELECT x.*
      FROM ( SELECT *, row_number() over (order by userkey DESC) rnum FROM user
       <where>
        <if test="type != ''">
          <choose>
            <when test="search_type == 'name'">AND name LIKE CONCAT('%', #{type}, '%')</when>
            <when test="search_type == 'id'">AND id LIKE CONCAT('%', #{type}, '%')</when>
            <when test="search_type == 'email'">AND email LIKE CONCAT('%', #{type}, '%')</when>
            <when test="search_type == 'phone'">AND phone LIKE CONCAT('%', #{type}, '%')</when>
            <when test="search_type == 'nickname'">AND nickname LIKE CONCAT('%', #{type}, '%')</when>
          </choose>
        </if>

        <if test="regist_start_date != '' and regist_end_date != ''">
          AND create_dtm BETWEEN #{regist_start_date} AND #{regist_end_date}
        </if>
        <if test="regist_start_date != '' and regist_end_date == ''">
          AND create_dtm <![CDATA[>=]]> #{regist_start_date}
        </if>
        <if test="regist_start_date == '' and regist_end_date != ''">
          AND create_dtm <![CDATA[<=]]> #{regist_end_date}
        </if>

        <if test="recent_login_start_date != '' and recent_login_end_date != ''">
          AND login_dtm BETWEEN #{recent_login_start_date} AND #{recent_login_end_date}
        </if>
        <if test="recent_login_start_date != '' and recent_login_end_date != ''">
          AND login_dtm <![CDATA[>=]]> #{recent_login_start_date}
        </if>
        <if test="recent_login_start_date != '' and recent_login_end_date != ''">
          AND login_dtm <![CDATA[<=]]> #{recent_login_end_date}
        </if>

        <if test="isdeleted != '2'">
          AND isdeleted = #{isdeleted}
        </if>

        <if test="isauthorized != '2'">
          AND isauthorized = #{isauthorized}
        </if>
       </where> 
    ) x
    WHERE x.rnum BETWEEN #{begin} and #{end}
    </select>

    <!-- 관리자 유저 정보 가져오기 -->
    <select id="getUserForAdmin" parameterType="String" resultType="com.sist.back.vo.userVO">
      select * from user
      where userkey = #{userkey}
    </select>

    <!-- 관리자 회원 탈퇴 -->
    <update id="userDelForAdmin" parameterType="String">
        UPDATE user
        SET isdeleted = 1, delete_dtm = now()
        WHERE userkey = #{userkey}
    </update>

    <!-- 관리자 유저정보 수정-->
    <update id="userEditForAdmin" parameterType="com.sist.back.vo.userVO">
        UPDATE user
        SET pw = #{pw}, email = #{email}, phone = #{phone}
        WHERE userkey = #{userkey}
    </update>


</mapper>
